name: Extract all the images from cs2

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Set-up s5cmd
        uses: peak/action-setup-s5cmd@main
        with:
          version: v2.0.0

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: "true"

      - name: checkoutLFS
        uses: actions/checkout@v4

      - run: git lfs pull

      - name: Cache DepotDownloader files
        uses: actions/cache@v4
        with:
          path: |
            data/.DepotDownloader
            data/game/csgo
            data/panorama/images/econ
          key: cs2-files-${{ hashFiles('data/.DepotDownloader/depot.config') }}
          restore-keys: |
            cs2-files-

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run JavaScript file
        run: bun run start

      - name: Clean up old SHA files
        run: |
          # Get the timestamp of the newest file
          NEWEST=$(find data/.DepotDownloader -maxdepth 1 -type f \( -name "*.bin" -o -name "*.manifest" \) -exec stat -f "%m" {} \; | sort -rn | head -1)
          # Remove SHA files that don't match the newest timestamp
          find data/.DepotDownloader -maxdepth 1 -name "*.sha" -type f ! -newermt "@$NEWEST" -delete 2>/dev/null || true
          # Also remove old bin and manifest files
          find data/.DepotDownloader -maxdepth 1 -type f \( -name "*.bin" -o -name "*.manifest" \) ! -newermt "@$NEWEST" -delete 2>/dev/null || true

      - name: Commit Files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Push Files
          file_pattern: "data/scripts/items/items_game.txt data/resource/csgo_english.txt data/.DepotDownloader"
          commit_user_name: "Flo4604 (via GitHub Actions)"

      - name: Sync files
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_ENDPOINT_URL: ${{ secrets.S3_ENDPOINT_URL }}
        run: |
          s5cmd sync --delete './data/panorama/images/econ/*' 's3://cs2cdn/econ/'
