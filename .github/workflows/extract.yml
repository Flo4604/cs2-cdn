name: Extract all the images from cs2

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Maximize build disk space
        uses: easimon/maximize-build-space@v10
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Set-up s5cmd
        uses: peak/action-setup-s5cmd@main
        with:
          version: v2.0.0

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: "true"

      - name: checkoutLFS
        uses: actions/checkout@v4

      - run: git lfs pull

      - name: Extract S3 endpoint hostname
        id: s3-endpoint
        run: |
          ENDPOINT="${{ secrets.S3_ENDPOINT_URL }}"
          # Remove https:// or http:// and trailing slashes
          ENDPOINT_HOST=$(echo "$ENDPOINT" | sed -e 's|^https\?://||' -e 's|/$||')
          echo "host=$ENDPOINT_HOST" >> $GITHUB_OUTPUT

      - name: Cache game files
        uses: tespkg/actions-cache@v1
        with:
          endpoint: ${{ steps.s3-endpoint.outputs.host }}
          accessKey: ${{ secrets.AWS_ACCESS_KEY_ID }}
          secretKey: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          bucket: cs2cdn
          region: ${{ secrets.AWS_REGION }}
          use-fallback: false
          path: |
            data/.DepotDownloader
            data/game/csgo
          key: cs2-files-${{ hashFiles('data/.DepotDownloader/depot.config') }}
          restore-keys: |
            cs2-files-

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: tespkg/actions-cache@v1
        with:
          endpoint: ${{ steps.s3-endpoint.outputs.host }}
          accessKey: ${{ secrets.AWS_ACCESS_KEY_ID }}
          secretKey: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          bucket: cs2cdn
          region: ${{ secrets.AWS_REGION }}
          use-fallback: false
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run JavaScript file
        run: bun run start

      - name: Sync files to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_ENDPOINT_URL: ${{ secrets.S3_ENDPOINT_URL }}
        run: |
          s5cmd sync --delete './data/panorama/images/econ/*' 's3://cs2cdn/econ/'

      - name: Analyze disk space usage
        run: |
          echo "=== Top 20 largest directories in root ==="
          du -h --max-depth=2 / 2>/dev/null | sort -rh | head -20
          echo ""
          echo "=== Top 20 largest directories in home ==="
          du -h --max-depth=3 ~ 2>/dev/null | sort -rh | head -20
          echo ""
          echo "=== Sizes of our data directory ==="
          du -h --max-depth=2 data 2>/dev/null | sort -rh

      - name: Clean up extracted files to save space
        run: |
          echo "Disk space before cleanup:"
          df -h
          # Remove extracted panorama images (already synced to S3)
          rm -rf data/panorama/images/econ/*
          echo "Disk space after cleanup:"
          df -h

      - name: Clean up old SHA files
        run: |
          # Get the timestamp of the newest file
          NEWEST=$(find data/.DepotDownloader -maxdepth 1 -type f \( -name "*.bin" -o -name "*.manifest" \) -exec stat -f "%m" {} \; | sort -rn | head -1)
          # Remove SHA files that don't match the newest timestamp
          find data/.DepotDownloader -maxdepth 1 -name "*.sha" -type f ! -newermt "@$NEWEST" -delete 2>/dev/null || true
          # Also remove old bin and manifest files
          find data/.DepotDownloader -maxdepth 1 -type f \( -name "*.bin" -o -name "*.manifest" \) ! -newermt "@$NEWEST" -delete 2>/dev/null || true

      - name: Commit Files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Push Files
          file_pattern: "data/scripts/items/items_game.txt data/resource/csgo_*.txt data/.DepotDownloader"
          commit_user_name: "Flo4604 (via GitHub Actions)"
